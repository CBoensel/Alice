{% extends "columnar-base.html" %}

{% block head %}
<script id="script-utils">
  function getOptions() {
    const formData = new FormData(document.getElementById('options-form'))
    const formOptions = Object.fromEntries(formData)
    formOptions['partner-id'] = document.getElementById('partner-id').value
    formOptions['client-id'] = document.getElementById('partner-client-id').value
    formOptions['merchant-id'] = document.getElementById('merchant-id').value
    formOptions['bn-code'] = document.getElementById('bn-code').value
    return formOptions
  }
  function copyToClipboard(id) {
    navigator.clipboard.writeText(document.getElementById(id).value)
  }
  function updateAPICalls(formattedCalls) {
    document.getElementById('api-calls').click()
    for (const id in formattedCalls) {
      if (formattedCalls.hasOwnProperty(id)) {
        const contents = formattedCalls[id]
        const apiCallTab = document.getElementById('api-calls-' + id)
        apiCallTab.innerHTML = contents
        const apiCallsButton = document.getElementById(id)
        enableButton(apiCallsButton)
        apiCallsButton.click()
      }
    }
  }
  function enableButton(button) {
    const disabledClassList = ["text-zinc-500", "dark:text-zinc-500", "cursor-not-allowed", "hidden"]
    const enabledClassList = ["hover:text-zinc-700", "hover:bg-zinc-100/50", "dark:hover:text-zinc-300", "dark:hover:bg-zinc-700/50"]

    button.classList.remove(...disabledClassList)
    button.classList.add(...enabledClassList)
  }
  function makeActiveButton(buttonList, button) {
    const activeClassList = ["text-blue-600", "bg-zinc-200/50", "dark:text-blue-500", "dark:bg-zinc-600/50", "active"]
    const inactiveClassList = ["hover:text-zinc-700", "hover:bg-zinc-100/50", "dark:hover:text-zinc-300", "dark:hover:bg-zinc-700/50"]

    buttonList.forEach(each => {
      each.classList.remove(...activeClassList)
      each.classList.add(...inactiveClassList)
    })

    button.classList.remove(...inactiveClassList)
    button.classList.add(...activeClassList)
  }
  function makeActiveTab(tabList, tab) {
    tabList.forEach(each => {each.classList.add("hidden");})
    tab.classList.remove("hidden")
  }
</script>
<script>
  function populateForm() {
    // Extract querystring parameters and populate form accordingly.
    const params = new Proxy(new URLSearchParams(window.location.search), {
      get: (searchParams, prop) => searchParams.get(prop),
    })
    const intent = params.intent
    document.getElementById('intent').value = intent

    const shippingPreference = params['shipping-preference']
    document.getElementById('shipping-preference').value = shippingPreference

    const price = params.price
    document.getElementById('price').value = price || 3.14

    const referenceID = params['reference-id']
    document.getElementById('reference-id').value = referenceID || ''

    const partnerFee = params['partner-fee']
    document.getElementById('partner-fee').value = partnerFee || 0

    const itemCategory = params['item-category']
    document.getElementById('item-category').value = itemCategory

    const BAToken = params['ba-token']
    document.getElementById('ba-token').value = BAToken || ''
  }
  // populateForm()
</script>
<script id="script-pp-utils">
  async function buildScriptElement(onload, vault=false) {
    const options = getOptions()
    const url = new URL('https://www.paypal.com/sdk/js')
    url.searchParams.append("client-id", options['client-id'])
    url.searchParams.append("merchant-id", options['merchant-id'])
    url.searchParams.append("intent", options['intent'].toLowerCase())
    url.searchParams.append("currency", options['currency'])
    url.searchParams.append("commit", true)
    url.searchParams.append("vault", vault)

    const oldScriptElement = document.getElementById('paypal-js-sdk')
    if (oldScriptElement.hasAttribute('src')) {
      const oldScriptURL = new URL(oldScriptElement.src)
      if (oldScriptURL.searchParams.has('components')) {
        const components = oldScriptURL.searchParams.get('components')
        url.searchParams.append('components', components)
      }
      if (oldScriptURL.searchParams.has('enable-funding')) {
        const enableFunding = oldScriptURL.searchParams.get('enable-funding')
        url.searchParams.append('enable-funding', enableFunding)
      }
      if (oldScriptURL.searchParams.has('disable-funding')) {
        const disableFunding = oldScriptURL.searchParams.get('disable-funding')
        url.searchParams.append('disable-funding', disableFunding)
      }
    }

    const newScriptElement = document.createElement('script')
    newScriptElement.id = 'paypal-js-sdk'
    newScriptElement.src = url.href
    if (oldScriptElement.hasAttribute('data-client-token')) {
      const dataClientToken = oldScriptElement.getAttribute('data-client-token')
      newScriptElement.setAttribute('data-client-token', dataClientToken)
    }

    const BNCode = options['bn-code']
    newScriptElement.setAttribute('data-partner-attribution-id', BNCode)
    newScriptElement.onload = onload

    oldScriptElement.replaceWith(newScriptElement)
  }
  async function resetCheckoutContainer() {
    const containerID = 'paypal-button-container'

    const newContainer = document.createElement('div')
    newContainer.setAttribute('id', containerID)

    const oldContainer = document.getElementById(containerID)
    oldContainer.replaceWith(newContainer)
  }
</script>
{% endblock %}

{% block foot %}
<script id="script-initial-api-calls">
  const formattedCalls = {{ formatted_calls|default('null')| safe }}
  if (formattedCalls !== null) {
    updateAPICalls(formattedCalls)
  }
</script>
<script id="script-init-tabs">
  function initializeTabsAndButtons(prefix) {
    const root = document.querySelector(`#${prefix}buttons-tabs`)
    const buttonContainer = root.querySelector(`#${prefix}buttons`)
    const tabContainer = root.querySelector(`#${prefix}tabs`)
    const buttonList = buttonContainer.querySelectorAll(".button")
    const tabList = root.querySelectorAll(`#${prefix}tabs > .tab`)
    buttonContainer.onclick = function(e) {
      const button = e.target
      const buttonId = button.getAttribute("id")
      if (buttonId != null && !button.classList.contains("cursor-not-allowed")) {
        makeActiveButton(buttonList, button)

        const tab = document.getElementById(`tab-${buttonId}`)
        if (tab === null) {
          console.log(`document.getElementById('tab-${buttonId}') found null!`)
        } else {
          makeActiveTab(tabList, tab)
        }
      }
    }
  }
  initializeTabsAndButtons('')
  initializeTabsAndButtons('api-calls-')
  document.getElementById("status-buttons").click()
</script>
<script id="script-buttons">
  async function getBaStatus() {
    console.group('Getting BA status...')
    const BAID = document.getElementById('ba-id').value
    console.log('Got the ID:', BAID)
    // const statusResponse = await fetch(`/api/billing-form/status/${BAID}`)
    const statusResponse = await fetch(`/api/billing-form/status/${BAID}`)
    console.log('Got the response:', statusResponse)
    const status = await statusResponse.json()
    console.log('Got the status:', status)
    updateAPICalls(status.formatted)
    console.groupEnd()
  }
  async function getOrderStatus() {
    console.group('Getting order status...')
    const orderId = document.getElementById('order-id').value
    console.log('Got the ID:', orderId)
    const statusResponse = await fetch(`/api/orders/status/${orderId}`)
    console.log('Got the response:', statusResponse)
    const status = await statusResponse.json()
    console.log('Got the status:', status)
    updateAPICalls(status.formatted)
    console.groupEnd()
  }

</script>
{% endblock %}

{% block left_col %}
<form id="options-form" class="space-y-4">
  <fieldset class="space-y-2">
    <legend class="block font-semibold">
      SDK Options
    </legend>
    <div class="ml-2 space-y-2">
      <div class="
      flex
      flex-row
      flex-wrap
      items-center
      justify-between
      ">
        <label for="intent" class="
        grow
        shrink-0
        basis-1/3
        whitespace-nowrap
        mr-auto
        ">
          Intent
        </label>
        <select name="intent" id="intent" class="
        leading-none
        px-2
        py-1
        basis-2/3
        grow
        rounded
        border
        focus:outline-none
        bg-zinc-100 dark:bg-zinc-700
        border-zinc-300 dark:border-zinc-600
        focus:bg-white dark:focus:bg-zinc-900
        focus:border-blue-500 dark:focus:border-blue-500
        ">
          <option value="CAPTURE" selected>Capture</option>
          <option value="AUTHORIZE">Authorize</option>
        </select>
      </div>
      <div class="
      flex
      flex-row
      flex-wrap
      items-center
      justify-between
      ">
        <label for="currency" class="
        grow
        shrink-0
        basis-1/3
        whitespace-nowrap
        mr-auto
        ">
          Currency
        </label>
        <select name="currency" id="currency" class="
        leading-none
        px-2
        py-1
        basis-2/3
        grow
        rounded
        border
        focus:outline-none
        bg-zinc-100 dark:bg-zinc-700
        border-zinc-300 dark:border-zinc-600
        focus:bg-white dark:focus:bg-zinc-900
        focus:border-blue-500 dark:focus:border-blue-500
        ">
          <option value="USD" selected>USD</option>
        </select>
      </div>
    </div>
  </fieldset>
  <fieldset class="space-y-2">
    <legend class="block font-semibold">Partner/merchant info</legend>
    <div class="ml-2 space-y-2">
      <div class="
      flex
      flex-row
      flex-wrap
      items-center
      justify-between
      ">
        <label for="partner-id" class="
        grow
        shrink-0
        basis-1/3
        whitespace-nowrap
        mr-auto
        ">
          Partner ID
        </label>
        <input id="partner-id" name="partner-id" value="{{ partner_id }}" disabled class="
        appearance-none
        px-2
        py-1
        min-w-0
        flex-auto
        basis-2/5
        border
        rounded
        leading-none
        font-mono
        focus:outline-none
        bg-zinc-100 dark:bg-zinc-700
        border-zinc-300 dark:border-zinc-600
        focus:border-blue-500
        ">
        <button type="button" onclick="copyToClipboard('partner-id')" class="
        px-2
        py-1
        ml-1
        basis-1/6
        rounded
        uppercase
        text-xs
        text-white
        bg-blue-600
        hover:bg-blue-700
        active:bg-blue-800
        focus:outline-none
        focus:ring
        focus:ring-blue-400
        ">
          copy
        </button>
      </div>
      <div class="
      flex
      flex-row
      flex-wrap
      items-center
      ">
        <label for="partner-client-id" class="
        grow
        shrink-0
        basis-1/3
        whitespace-nowrap
        mr-auto
        ">
          Client ID
        </label>
        <input id="partner-client-id" name="partner-client-id" value="{{ partner_client_id }}" disabled class="
        appearance-none
        px-2
        py-1
        min-w-0
        flex-auto
        basis-2/5
        border
        rounded
        leading-none
        font-mono
        focus:outline-none
        bg-zinc-100 dark:bg-zinc-700
        border-zinc-300 dark:border-zinc-600
        focus:border-blue-500
        ">
        <button type="button" onclick="copyToClipboard('partner-client-id')" class="
        px-2
        py-1
        ml-1
        basis-1/6
        rounded
        uppercase
        text-xs
        text-white
        bg-blue-600
        hover:bg-blue-700
        active:bg-blue-800
        focus:outline-none
        focus:ring
        focus:ring-blue-400
        ">
          copy
        </button>
      </div>
      <div class="
      flex
      flex-row
      flex-wrap
      items-center
      ">
        <label for="bn-code" class="
        grow
        shrink-0
        basis-1/3
        whitespace-nowrap
        mr-auto
        ">
          BN Code
        </label>
        <input id="bn-code" name="bn-code" value="{{ bn_code }}" disabled class="
        appearance-none
        px-2
        py-1
        min-w-0
        flex-auto
        basis-2/5
        border
        rounded
        leading-none
        font-mono
        focus:outline-none
        bg-zinc-100 dark:bg-zinc-700
        border-zinc-300 dark:border-zinc-600
        focus:border-blue-500
        ">
        <button type="button" onclick="copyToClipboard('bn-code')" class="
        px-2
        py-1
        ml-1
        basis-1/6
        rounded
        uppercase
        text-xs
        text-white
        bg-blue-600
        hover:bg-blue-700
        active:bg-blue-800
        focus:outline-none
        focus:ring
        focus:ring-blue-400
        ">
          copy
        </button>
      </div>
      <div class="
      flex
      flex-row
      flex-wrap
      items-center
      ">
        <label for="merchant-id" class="
        grow
        shrink-0
        basis-1/3
        whitespace-nowrap
        mr-auto
        ">
          Merchant ID
        </label>
        <input id="merchant-id" name="merchant-id" value="{{ merchant_id }}" disabled class="
        appearance-none
        px-2
        py-1
        min-w-0
        flex-auto
        basis-2/5
        border
        rounded
        leading-none
        font-mono
        focus:outline-none
        bg-zinc-100 dark:bg-zinc-700
        border-zinc-300 dark:border-zinc-600
        focus:border-blue-500
        ">
        <button type="button" onclick="copyToClipboard('merchant-id')" class="
        px-2
        py-1
        ml-1
        basis-1/6
        rounded
        uppercase
        text-xs
        text-white
        bg-blue-600
        hover:bg-blue-700
        active:bg-blue-800
        focus:outline-none
        focus:ring
        focus:ring-blue-400
        ">
          copy
        </button>
      </div>
    </div>
  </fieldset>
  {% block checkout_options %}
  {% endblock %}
  <fieldset class="space-y-2">
    <legend class="block font-semibold">
      Info
    </legend>
    <div class="ml-2 space-y-2">
      <fieldset class="
      flex
      flex-row
      flex-wrap
      items-center
      justify-between
      ">
        <label for="ba-id" class="
        grow
        shrink-0
        basis-1/3
        whitespace-nowrap
        mr-auto
        ">
          BA ID
        </label>
        <input id="ba-id" name="ba-id" class="
        appearance-none
        leading-none
        px-2
        py-1
        min-w-0
        flex-auto
        basis-2/3
        font-mono
        rounded
        border
        focus:outline-none
        bg-zinc-100 dark:bg-zinc-700
        border-zinc-300 dark:border-zinc-600
        focus:bg-white dark:focus:bg-zinc-900
        focus:border-blue-500 dark:focus:border-blue-500
        ">
      </fieldset>
      <fieldset class="
      flex
      flex-row
      flex-wrap
      items-center
      justify-between
      ">
        <label for="order-id" class="
        grow
        shrink-0
        basis-1/3
        whitespace-nowrap
        mr-auto
        ">
          Order ID
        </label>
        <input id="order-id" name="order-id" class="
        appearance-none
        leading-none
        px-2
        py-1
        min-w-0
        flex-auto
        basis-2/3
        font-mono
        rounded
        border
        focus:outline-none
        bg-zinc-100 dark:bg-zinc-700
        border-zinc-300 dark:border-zinc-600
        focus:bg-white dark:focus:bg-zinc-900
        focus:border-blue-500 dark:focus:border-blue-500
        ">
      </fieldset>
    </div>
  </fieldset>
{% endblock %}

{% block right_col %}
<div id="buttons-tabs">
  <!-- Buttons for tabs -->
  <div id="buttons">
    <ul class="
    flex
    flex-wrap
    text-center
    border-b
    mb-2
    text-zinc-600 dark:text-zinc-400
    border-zinc-300 dark:border-zinc-600
    ">
      <li class="mr-2">
        <a href="#" id="status-buttons" class="
        button
        inline-block
        p-4
        rounded-t-lg
        hover:text-zinc-700 dark:hover:text-zinc-300
        hover:bg-zinc-100 dark:hover:bg-zinc-700
        ">Buttons</a>
      </li>
      <li class="mr-2">
        <a href="#" id="api-calls" class="
        button
        inline-block
        p-4
        rounded-t-lg
        hover:text-zinc-700 dark:hover:text-zinc-300
        hover:bg-zinc-100 dark:hover:bg-zinc-700
        ">API Calls</a>
      </li>
    </ul>
  </div>

  <!-- Tabs -->
  <div id="tabs" class="w-100">
    <div id="tab-status-buttons" class="tab center hidden">
      <button type='button' id='button-get-ba-status' onclick="getBaStatus()" class="
      px-2
      py-1
      rounded
      text-white
      bg-blue-600
      hover:bg-blue-700
      active:bg-blue-800
      focus:outline-none
      focus:ring
      focus:ring-blue-400
      ">
        Get BA Status
      </button><br/>
      <button type='button' id='button-get-order-status' onclick="getOrderStatus()" class="
      px-2
      py-1
      rounded
      text-white
      bg-blue-600
      hover:bg-blue-700
      active:bg-blue-800
      focus:outline-none
      focus:ring
      focus:ring-blue-400
      ">
        Get order Status
      </button>
    </div>
    <div id="tab-api-calls" class="tab center hidden">
      <div id="api-calls-buttons-tabs">
        <!-- Buttons for tabs -->
        <div id="api-calls-buttons">
          <ul class="
          flex
          flex-wrap
          text-center
          border-b
          mb-2
          text-zinc-500 dark:text-zinc-500
          border-zinc-300 dark:border-zinc-600
          ">
            <li>
              <a id="access-token" href="#" class="
              button
              inline-block
              p-4
              rounded-t-lg
              cursor-not-allowed
              ">Access Token</a>
            </li>
            <li>
              <a id="ba-status" href="#" class="
              button
              inline-block
              p-4
              rounded-t-lg
              cursor-not-allowed
              hidden
              ">BA Status</a>
            </li>
            <li>
              <a id="order-status" href="#" class="
              button
              inline-block
              p-4
              rounded-t-lg
              cursor-not-allowed
              hidden
              ">Order Status</a>
            </li>
          </ul>
        </div>
        <!-- Tabs -->
        <div id="api-calls-tabs" class="font-mono dark:text-zinc-100">
          <div id="tab-access-token" class="tab center hidden">
            <div id="api-calls-access-token" class="
            w-full
            top-0
            p-2
            break-words
            whitespace-pre-wrap
            bg-zinc-100 dark:bg-zinc-700
            "></div>
          </div>
          <div id="tab-ba-status" class="tab center hidden">
            <div id="api-calls-ba-status" class="
            w-full
            top-0
            p-2
            break-words
            whitespace-pre-wrap
            bg-zinc-100 dark:bg-zinc-700
            "></div>
          </div>
          <div id="tab-order-status" class="tab center hidden">
            <div id="api-calls-order-status" class="
            w-full
            top-0
            p-2
            break-words
            whitespace-pre-wrap
            bg-zinc-100 dark:bg-zinc-700
            "></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}